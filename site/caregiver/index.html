<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Caregiver Services Agreement — Fast Legal Templates</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;800&display=swap');
  :root{--primary:#059669;--accent:#f59e0b;--ink:#111827;--bg:#f3f4f6}
  html,body{background:#f3f4f6;font-family:'Inter',system-ui,Arial,sans-serif}
  .preview-box{min-height:520px;white-space:pre-wrap;tab-size:4;line-height:1.55}
  .watermark{color:rgba(5,150,105,.10);font-weight:800;font-size:3rem;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) rotate(-15deg);pointer-events:none}
  .unlocked .watermark{display:none!important}
  .step-dot{width:.75rem;height:.75rem;border-radius:9999px;background:#e5e7eb}
  .step-dot.active{background:var(--primary)}
  .qhelp{background:#ecfeff;border:1px solid #bae6fd;color:#0369a1}
</style>
</head>
<body class="p-4 md:p-8 text-gray-900">

<header class="max-w-7xl mx-auto flex items-center justify-between gap-4 mb-4">
  <a href="/" class="text-sm text-gray-600 hover:text-gray-800">&larr; Home</a>
  <h1 class="text-2xl md:text-3xl font-extrabold text-emerald-700">Caregiver Services Agreement</h1>
  <div class="text-xs text-gray-500">Draft updates live</div>
</header>

<main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- LEFT: FORM -->
  <section class="lg:col-span-2 bg-white border rounded-xl shadow p-5">
    <!-- Progress -->
    <div class="flex items-center gap-2 mb-4">
      <div id="stepDots" class="flex items-center gap-2"></div>
      <div class="ml-auto text-sm text-gray-500"><span id="stepLabel">Step 1</span> of <span id="stepTotal">7</span></div>
    </div>

    <div id="formMount"></div>

    <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
      <button id="btnBack" class="bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg py-2 px-3 hidden">Back</button>
      <button id="btnNext" class="sm:col-span-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg py-2 px-3">Continue</button>
    </div>

    <div id="checkoutBlock" class="hidden mt-6 pt-5 border-t">
      <h3 class="text-lg font-bold mb-2">Step 7 — Checkout</h3>
      <p class="text-sm text-gray-600 mb-3">Your personalized agreement is ready. After payment you'll receive the downloadable file and a backup via email.</p>
      <button id="btnBuy" class="bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg py-2 px-4">Buy Now</button>
      <p class="text-xs text-gray-500 mt-2">Secure Stripe Checkout will open.</p>
    </div>
  </section>

  <!-- RIGHT: PREVIEW -->
  <aside class="bg-white border rounded-xl shadow p-5 relative">
    <h2 class="text-lg font-bold mb-3">Live Preview</h2>
    <div class="relative">
      <div class="watermark">UNPAID DRAFT</div>
      <pre id="preview" class="preview-box text-sm"></pre>
    </div>
  </aside>
</main>

<script>
/* ========= CONFIG ========= */
const PRICE_ID = "price_1SKKSnHcizSl783nL20brMXo"; // caregiver price you provided
const SUCCESS_PATH = "/caregiver/success.html";

/* ========= FORM MODEL =========
   We use steps with radio/selects wherever possible.
   Nothing from your previous working flow is removed; we’re only adding or clarifying fields.
*/
const STATES = ["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming","District of Columbia"];

const steps = [
/* 1. About You & Parties */
{
  title: "About You & Parties",
  fields: [
    {ref:"buyerEmail", label:"Your Email", type:"email", required:true, placeholder:"you@example.com"},
    {ref:"buyerName", label:"Your Name", type:"text", required:false, placeholder:"Your full name"},
    {ref:"clientName", label:"Client (person receiving care) — Full Name", type:"text", required:true, placeholder:"Client full legal name"},
    {ref:"caregiverName", label:"Caregiver — Full Name", type:"text", required:true, placeholder:"Caregiver full legal name"},
    {ref:"arrangementType", label:"Arrangement Type", type:"select", required:true, options:["W-2 Employee","1099 Independent Contractor"]},
    {ref:"state", label:"State of Service", type:"select", required:true, options:STATES},
    {ref:"county", label:"County/City for arbitration/venue", type:"text", required:true, placeholder:"e.g., Westchester County"},
    {ref:"clientAddr", label:"Client Service Address (workplace)", type:"text", required:true, placeholder:"Street, City, State ZIP"},
    {ref:"employerSigner", label:"Employer/Signer Name (who signs & pays)", type:"text", required:true, placeholder:"e.g., Daughter (POA) — Jane Doe"},
    {ref:"employerAddr", label:"Employer/Client Mailing Address", type:"text", required:true, placeholder:"Street, City, State ZIP"}
  ]
},

/* 2. Basics & Pay */
{
  title: "Basics & Pay",
  fields: [
    {ref:"startDate", label:"Start Date", type:"date", required:true},
    {ref:"careLocation", label:"Care Location (city/state)", type:"text", required:true, placeholder:"e.g., Scarsdale, NY"},
    {ref:"payStructureEmp", label:"Employee Pay Structure", type:"radio", required:true, showIf:{arrangementType:"W-2 Employee"}, options:["Hourly","Fixed Daily Rate","Fixed Weekly/Salary Rate"]},
    {ref:"rateHourly", label:"Hourly Rate ($/hr)", type:"number", step:"0.01", min:"0", required:true, showIf:{arrangementType:"W-2 Employee", payStructureEmp:"Hourly"}},
    {ref:"rateDaily", label:"Fixed Daily Amount ($/day)", type:"number", step:"0.01", min:"0", required:true, showIf:{arrangementType:"W-2 Employee", payStructureEmp:"Fixed Daily Rate"}},
    {ref:"rateWeekly", label:"Fixed Weekly/Salary Amount ($/wk)", type:"number", step:"0.01", min:"0", required:true, showIf:{arrangementType:"W-2 Employee", payStructureEmp:"Fixed Weekly/Salary Rate"}},
    {ref:"paySchedule", label:"Pay Schedule", type:"select", required:true, options:["weekly","biweekly","monthly"]},
    {ref:"hoursSchedule", label:"Typical Hours / Days", type:"textarea", required:true, placeholder:"e.g., Mon–Fri 9am–5pm; occasional weekends"},
    {ref:"weeklyHours", label:"Expected Total Weekly Hours", type:"number", min:"1", required:true},
    /* IC */
    {ref:"icPayType", label:"Independent Contractor — Payment Method", type:"radio", required:true, showIf:{arrangementType:"1099 Independent Contractor"}, options:["Project Fee","Milestones","Retainer"]},
    {ref:"icTotal", label:"IC: Total Fee/Retainer ($)", type:"number", step:"0.01", min:"0", required:true, showIf:{arrangementType:"1099 Independent Contractor"}}
  ]
},

/* 3. Duties (Service Categories) — ADDED */
{
  title: "Service Categories & Details",
  fields: [
    {ref:"svcPersonal", label:"Personal Care (bathing, grooming, dressing, toileting, mobility assistance)", type:"checkbox"},
    {ref:"svcPersonalDetails", label:"Personal Care — details/limits", type:"textarea", placeholder:"e.g., transfer belt; bathing schedule"},
    {ref:"svcMedical", label:"Medical/Health Support (med reminders/admin, appts, vitals)", type:"checkbox"},
    {ref:"svcMedicalDetails", label:"Medical/Health — details/limits", type:"textarea", placeholder:"e.g., reminders only; record BP daily"},
    {ref:"svcHousehold", label:"Household Tasks (light housekeeping, laundry, dishes, meal prep, errands)", type:"checkbox"},
    {ref:"svcHouseholdDetails", label:"Household — details", type:"textarea", placeholder:"e.g., vacuum weekly; laundry 1x/week; low-salt meal prep"},
    {ref:"svcCompanionship", label:"Companionship (social interaction, reading, hobbies, transportation)", type:"checkbox"},
    {ref:"svcCompanionshipDetails", label:"Companionship — details", type:"textarea", placeholder:"e.g., daily walk 20 min; read newspaper; drive on Fridays"},
    {ref:"svcOther", label:"Other services (add anything else)", type:"checkbox"},
    {ref:"svcOtherDetails", label:"Other — details", type:"textarea", placeholder:"Describe any additional duties"}
  ]
},

/* 4. Funds, Reimbursement, Medicaid */
{
  title: "Funds, Reimbursement & Medicaid",
  fields: [
    {ref:"pettyCashAllowed", label:"Will Caregiver handle petty cash for authorized purchases?", type:"radio", required:true, options:["Yes","No"]},
    {ref:"pettyCashMax", label:"Max petty cash per transaction ($)", type:"number", step:"0.01", min:"0", required:true, showIf:{pettyCashAllowed:"Yes"}},
    {ref:"reimburseAllowed", label:"Reimbursement for pre-approved necessary expenses?", type:"radio", required:true, options:["Yes","No"]},
    {ref:"rbReceipts", label:"Require: Original receipts", type:"checkbox", showIf:{reimburseAllowed:"Yes"}},
    {ref:"rbMileage", label:"Require: Mileage log", type:"checkbox", showIf:{reimburseAllowed:"Yes"}},
    {ref:"rbInvoice", label:"Require: Itemized invoice", type:"checkbox", showIf:{reimburseAllowed:"Yes"}},
    {ref:"rbPreapproval", label:"Require: Written pre-approval", type:"checkbox", showIf:{reimburseAllowed:"Yes"}},
    {ref:"rbOther", label:"Other documentation (optional)", type:"text", placeholder:"e.g., delivery confirmation", showIf:{reimburseAllowed:"Yes"}},
    {ref:"medicaidRisk", label:"Medicaid look-back risk for next 5 years?", type:"radio", required:true, options:["Yes","No","I don't know"], help:"If Yes/Unsure, we insert strong 'Fair Market Value' language."}
  ]
},

/* 5. Live-In / Overnight / Amenities */
{
  title: "Live-In / Overnight & Amenities",
  fields: [
    {ref:"liveInType", label:"Does this include Overnight or Live-In?", type:"radio", required:true, options:["Live-Out","Overnight","Live-In"]},
    {ref:"privateQuarters", label:"Describe private living space (if Overnight/Live-In)", type:"text", placeholder:"e.g., Private bedroom with shared hall bath", showIfAny:[{liveInType:"Overnight"},{liveInType:"Live-In"}]},
    {ref:"sleepHours", label:"Designated non-compensable sleep hours (max 8)", type:"number", min:"0", max:"8", showIfAll:[{arrangementType:"W-2 Employee"},{liveInType:"Overnight,Live-In"}]},
    {ref:"onCallSleep", label:"During sleep time, is employee 'on-call'?", type:"radio", options:["Yes","No"], showIfAll:[{arrangementType:"W-2 Employee"},{liveInType:"Overnight,Live-In"}]},
    {ref:"roomBoardDeduct", label:"Will Room & Board value be deducted from wages?", type:"radio", options:["Yes","No"], showIfAll:[{arrangementType:"W-2 Employee"},{liveInType:"Overnight,Live-In"}]},
    /* Amenities */
    {ref:"amKitchen", label:"Amenities: Kitchen use for personal meals?", type:"radio", required:true, options:["Yes","No"]},
    {ref:"amLaundry", label:"Amenities: Washer/Dryer for personal clothing?", type:"radio", required:true, options:["Yes","No"]},
    {ref:"amInternet", label:"Amenities: Home Wi-Fi/TV for limited personal use?", type:"radio", required:true, options:["Yes","No"]},
    {ref:"amFood", label:"Amenities: May consume family/client food/groceries?", type:"radio", required:true, options:["Yes","No"]}
  ]
},

/* 6. Safety, Insurance, Monitoring, Notes */
{
  title: "Safety, Insurance, Monitoring & Notes",
  fields: [
    {ref:"bonding", label:"Bonding / Fidelity", type:"select", required:true, options:["Yes, a Fidelity Bond has been obtained.","No, but caregiver must be bondable.","Neither required"]},
    {ref:"monitoring", label:"Monitoring devices in common areas?", type:"radio", required:true, options:["Yes","No"], help:"Never in private rooms/bathrooms."},
    {ref:"reportName", label:"Mandatory Reporting Contact — Name", type:"text", required:true},
    {ref:"reportContact", label:"Mandatory Reporting Contact — Phone/Email", type:"text", required:true},
    {ref:"noticeDays", label:"Termination Notice Period (days)", type:"number", min:"7", required:true},
    /* Insurance requirement (NEW explicit Q) */
    {ref:"insRequired", label:"Is caregiver required to maintain insurance?", type:"radio", required:true, options:["Yes","No"]},
    {ref:"insProf", label:"Professional Liability (min coverage)", type:"text", placeholder:"e.g., $1,000,000 per claim", showIf:{insRequired:"Yes"}},
    {ref:"insGen", label:"General Liability (min coverage)", type:"text", placeholder:"e.g., $1,000,000 per occurrence", showIf:{insRequired:"Yes"}},
    {ref:"notes", label:"Notes (optional)", type:"textarea", placeholder:"Any limits or instructions to include verbatim"}
  ]
},

/* 7. Review & Checkout (no fields; shows summary & Buy button) */
{
  title: "Review & Checkout",
  fields: []
}
];

const state = {}; // form answers

/* ========= RENDERING ========= */
const el = (tag, attrs={}, html="")=>{
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if (k==="class") n.className=v;
    else if (k==="for") n.htmlFor=v;
    else n.setAttribute(k,v);
  });
  if (html) n.innerHTML = html;
  return n;
};

let stepIndex = 0;

function showStep(idx){
  stepIndex = idx;
  const root = document.getElementById("formMount");
  root.innerHTML = "";
  const s = steps[stepIndex];

  // title
  root.appendChild(el("h2",{class:"text-xl font-bold mb-3"}, s.title));

  s.fields.forEach(f=>{
    if (!shouldShow(f)) return;

    const wrap = el("div",{class:"mb-4"});
    wrap.appendChild(el("label",{class:"block text-sm font-medium mb-1", for:f.ref}, f.label));

    let control;
    if (f.type==="text" || f.type==="email" || f.type==="date" || f.type==="number") {
      control = el("input",{id:f.ref, class:"border rounded w-full p-2", type:f.type, placeholder:f.placeholder||"", step:f.step||"", min:f.min||"", max:f.max||""});
      if (state[f.ref]!=null) control.value = state[f.ref];
      control.addEventListener("input", onChange);
    } else if (f.type==="textarea") {
      control = el("textarea",{id:f.ref, class:"border rounded w-full p-2", rows:"2", placeholder:f.placeholder||""});
      if (state[f.ref]!=null) control.value = state[f.ref];
      control.addEventListener("input", onChange);
    } else if (f.type==="select") {
      control = el("select",{id:f.ref, class:"border rounded w-full p-2"});
      (f.options||[]).forEach(opt=>{
        const o = el("option", {value:opt}, opt);
        if (state[f.ref]===opt) o.selected = true;
        control.appendChild(o);
      });
      control.addEventListener("change", onChange);
    } else if (f.type==="radio") {
      control = el("div",{class:"space-y-2"});
      (f.options||[]).forEach((opt,i)=>{
        const lid = f.ref + "_" + i;
        const row = el("label",{class:"flex items-center gap-2", for:lid});
        const r = el("input",{type:"radio", id:lid, name:f.ref, value:opt});
        if (state[f.ref]===opt) r.checked = true;
        r.addEventListener("change", onChange);
        row.appendChild(r);
        row.appendChild(el("span",{}, opt));
        control.appendChild(row);
      });
    } else if (f.type==="checkbox") {
      control = el("input",{id:f.ref, type:"checkbox", class:"h-4 w-4"});
      if (state[f.ref]===true) control.checked = true;
      control.addEventListener("change", onChange);
    }

    wrap.appendChild(control);
    if (f.help) wrap.appendChild(el("p",{class:"qhelp text-xs p-2 rounded mt-2"}, f.help));
    if (f.required) wrap.appendChild(el("div",{class:"text-[11px] text-gray-500 mt-1"}, "Required"));

    root.appendChild(wrap);
  });

  // nav state
  document.getElementById("btnBack").classList.toggle("hidden", stepIndex===0);
  const isLast = (stepIndex===steps.length-1);
  document.getElementById("btnNext").classList.toggle("hidden", isLast);
  document.getElementById("checkoutBlock").classList.toggle("hidden", !isLast);
  document.getElementById("stepLabel").textContent = (stepIndex+1);
  document.getElementById("stepTotal").textContent = steps.length;

  paintDots();
  refreshPreview();
}

function shouldShow(f){
  // showIf exact
  if (f.showIf){
    return Object.entries(f.showIf).every(([k,v])=>{
      return state[k]===v;
    });
  }
  // showIfAll: array of {key: value or csv}
  if (f.showIfAll){
    return f.showIfAll.every(rule=>{
      const key = Object.keys(rule)[0];
      const val = rule[key];
      if (String(val).includes(",")) {
        return String(val).split(",").map(x=>x.trim()).includes(state[key]);
      }
      return state[key]===val;
    });
  }
  // showIfAny: array of {key: value}
  if (f.showIfAny){
    return f.showIfAny.some(rule=>{
      const key = Object.keys(rule)[0];
      const val = rule[key];
      return state[key]===val;
    });
  }
  return true;
}

function onChange(ev){
  const t = ev.target;
  // radios have name
  if (t.type==="radio"){
    state[t.name] = t.value;
  } else if (t.type==="checkbox"){
    state[t.id] = t.checked;
  } else {
    state[t.id] = t.value;
  }
  // re-render if visibility dependencies can change
  showStep(stepIndex);
}

function validateStep(){
  const s = steps[stepIndex];
  for (const f of s.fields){
    if (!shouldShow(f)) continue;
    if (!f.required) continue;
    const v = state[f.ref];
    if (f.type==="checkbox"){
      // required checkbox → must be true
      if (v!==true) return false;
    } else {
      if (v==null || String(v).trim()==="") return false;
    }
  }
  return true;
}

function nextStep(){
  if (!validateStep()){
    alert("Please complete all required fields on this step.");
    return;
  }
  if (stepIndex < steps.length-1){
    showStep(stepIndex+1);
    window.scrollTo({top:0,behavior:"smooth"});
  }
}
function prevStep(){
  if (stepIndex>0){
    showStep(stepIndex-1);
    window.scrollTo({top:0,behavior:"smooth"});
  }
}

function paintDots(){
  const d = document.getElementById("stepDots");
  d.innerHTML = "";
  for (let i=0;i<steps.length;i++){
    d.appendChild(el("div",{class:"step-dot"+(i===stepIndex?" active":"")}));
  }
}

/* ========= PREVIEW BUILDER ========= */
function buildServices(){
  const rows = [];
  if (state.svcPersonal) rows.push("• Personal Care — " + (state.svcPersonalDetails||"as specified"));
  if (state.svcMedical) rows.push("• Medical/Health Support — " + (state.svcMedicalDetails||"as specified"));
  if (state.svcHousehold) rows.push("• Household Tasks — " + (state.svcHouseholdDetails||"as specified"));
  if (state.svcCompanionship) rows.push("• Companionship — " + (state.svcCompanionshipDetails||"as specified"));
  if (state.svcOther) rows.push("• Other Services — " + (state.svcOtherDetails||"as specified"));
  return rows.length? rows.join("\n") : "• (None selected)";
}

function buildReimburse(){
  if (state.reimburseAllowed==="Yes"){
    const docs = [];
    if (state.rbReceipts) docs.push("Original receipts");
    if (state.rbMileage) docs.push("Mileage log");
    if (state.rbInvoice) docs.push("Itemized invoice");
    if (state.rbPreapproval) docs.push("Written pre-approval");
    if ((state.rbOther||"").trim()) docs.push("Other: "+state.rbOther.trim());
    return `Reimbursement: Allowed for pre-approved, necessary expenses.\nRequired documentation: ${docs.length? docs.join(", ") : "as requested"}.`;
  }
  return "Reimbursement: Not allowed without prior written approval.";
}

function buildInsurance(){
  if (state.insRequired==="Yes"){
    return `Caregiver Insurance: Required. Minimum coverage — Professional Liability: ${state.insProf||"(specify)"}; General Liability: ${state.insGen||"(specify)"}.
`;
  }
  return "Caregiver Insurance: Not required under this Agreement (unless required by law).\n";
}

function buildCompensation(){
  if (state.arrangementType==="W-2 Employee"){
    if (state.payStructureEmp==="Hourly"){
      return `Compensation — Employee (Hourly)\nRate: ${state.rateHourly?("$"+Number(state.rateHourly).toFixed(2)+"/hr"):"[Rate]"}\nPay Schedule: ${state.paySchedule||"[Schedule]"}\nTypical Hours/Days: ${state.hoursSchedule||"[e.g., Mon–Fri 9–5]"}\nExpected Weekly Hours: ${state.weeklyHours||"[hours]"}\n`;
    } else if (state.payStructureEmp==="Fixed Daily Rate"){
      return `Compensation — Employee (Fixed Daily)\nDaily Amount: ${state.rateDaily?("$"+Number(state.rateDaily).toFixed(2)):"[Daily Amount]"}\nPay Schedule: ${state.paySchedule||"[Schedule]"}\nTypical Hours/Days: ${state.hoursSchedule||"[e.g., Mon–Fri 9–5]"}\nExpected Weekly Hours: ${state.weeklyHours||"[hours]"}\n`;
    } else {
      return `Compensation — Employee (Fixed Weekly/Salary)\nWeekly Amount: ${state.rateWeekly?("$"+Number(state.rateWeekly).toFixed(2)):"[Weekly Amount]"}\nPay Schedule: ${state.paySchedule||"[Schedule]"}\nTypical Hours/Days: ${state.hoursSchedule||"[e.g., Mon–Fri 9–5]"}\nExpected Weekly Hours: ${state.weeklyHours||"[hours]"}\n`;
    }
  } else {
    return `Compensation — Independent Contractor\nPayment Method: ${state.icPayType||"[Method]"}\nTotal Fee/Retainer: ${state.icTotal?("$"+Number(state.icTotal).toFixed(2)):"[Amount]"}\nTypical Hours/Days: ${state.hoursSchedule||"[e.g., Mon–Fri 9–5]"}\n`;
  }
}

function buildFunds(){
  const petty = (state.pettyCashAllowed==="Yes")
    ? `Authorized petty cash for specific purchases, up to $${Number(state.pettyCashMax||0).toFixed(2)} per transaction.`
    : `No petty cash handling is authorized without written approval.`;
  const medicaid = (state.medicaidRisk && state.medicaidRisk!=="No")
    ? `Medicaid Look-Back Warning: Compensation/duties reflect Fair Market Value to protect eligibility within the 5-year look-back.`
    : `Medicaid Look-Back: Not indicated as a risk by Client.`;
  return petty + "\n" + medicaid;
}

function buildLiveIn(){
  let s = `Arrangement: ${state.liveInType||"[Live-Out/Overnight/Live-In]"}\n`;
  if (state.liveInType==="Overnight" || state.liveInType==="Live-In"){
    s += `Private Quarters: ${state.privateQuarters||"(describe)"}\n`;
    if (state.arrangementType==="W-2 Employee"){
      s += `Sleep Time: ${state.sleepHours||"0"} hrs designated non-compensable (if 5+ hrs uninterrupted sleep).\n`;
      s += `On-Call During Sleep: ${state.onCallSleep||"[Yes/No]"}\n`;
      s += `Room & Board Deduction: ${state.roomBoardDeduct||"[Yes/No]"}\n`;
    } else {
      s += `Note: Live-In IC arrangements may imply employment; review classification risk.\n`;
    }
  }
  s += `\nAmenities\n- Kitchen: ${state.amKitchen||"[Yes/No]"}\n- Laundry: ${state.amLaundry||"[Yes/No]"}\n- Internet/TV: ${state.amInternet||"[Yes/No]"}\n- Food: ${state.amFood||"[Yes/No]"}\n`;
  return s;
}

function buildHIPAA(){
return `Confidentiality & Privacy (HIPAA)
The Caregiver will maintain strict confidentiality of all Client information; will not disclose without written consent (unless required by law); and will comply with applicable state/federal privacy laws, including HIPAA, to the extent applicable.`;
}

function buildIndemn(){
return `Indemnification
The Caregiver agrees to indemnify and hold harmless the Client from claims, losses, damages, or liability arising from the Caregiver’s negligence, gross misconduct, or intentional acts.`;
}

function buildBondingMonitoring(){
  const b = state.bonding || "";
  const m = (state.monitoring==="Yes")
    ? "Notice: Video/audio monitoring is in use in common areas only (never private rooms/bathrooms)."
    : "No monitoring devices are in use.";
  return `Bonding/Fidelity: ${b}\n${m}`;
}

function buildPreviewText(){
  const svcBlock = buildServices();
  const reimb = buildReimburse();
  const ins = buildInsurance();
  const comp = buildCompensation();
  const funds = buildFunds();
  const live = buildLiveIn();
  const hipaa = buildHIPAA();
  const indemn = buildIndemn();
  const bondMon = buildBondingMonitoring();

  return `
CAREGIVER SERVICES AGREEMENT

Client: ${state.clientName||"[Client Name]"}
Caregiver: ${state.caregiverName||"[Caregiver Name]"}
Arrangement Type: ${state.arrangementType||"[W-2/1099]"}
Start Date: ${state.startDate||"[Start Date]"}
Care Location: ${state.careLocation||"[City/State]"}
Governing Law: ${state.state||"[State]"}
Arbitration Venue: ${state.county||"[County/City]"}
Workplace Address: ${state.clientAddr||"[Address]"}

${comp}

Scope of Services
${svcBlock}

${reimb}

${ins}
${hipaa}

${indemn}

Funds & Financial Limits
${funds}

Live-In / Overnight & Amenities
${live}

Safety, Reporting & Conduct
Mandatory Reporting to: ${state.reportName||"[Name]"} (${state.reportContact||"[Contact]"})
Notice to Terminate: ${state.noticeDays||"[days]"} days
${bondMon}

Special Notes
${(state.notes||"(none)")}

Signatures
Client: ______________________   Date: __________
Caregiver: ____________________   Date: __________
`.trim();
}

function refreshPreview(){
  document.getElementById("preview").textContent = buildPreviewText();
}

/* ========= CHECKOUT FLOW ========= */
async function saveDraft(){
  const email = (state.buyerEmail||"").trim();
  const name = (state.buyerName||state.caregiverName||state.clientName||"Customer").trim();
  const product = "Caregiver Services Agreement";
  const content = buildPreviewText();

  const r = await fetch('/.netlify/functions/save-draft', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ email, name, product, content })
  });
  if (!r.ok) throw new Error("save-draft failed");
  return r.json(); // {draftId}
}

async function startCheckout(){
  try{
    if (!state.buyerEmail || !String(state.buyerEmail).includes("@")){
      alert("Please enter your email first.");
      return;
    }
    const ok = validateStep(); // ensure the final step also passes the earlier required checks
    if (!ok){ alert("Please complete required fields before checkout."); return; }

    const { draftId } = await saveDraft();

    const r = await fetch('/.netlify/functions/create-checkout', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        draftId,
        email: state.buyerEmail,
        priceId: PRICE_ID,
        successPath: SUCCESS_PATH
      })
    });
    if (!r.ok){
      const t = await r.text();
      console.error(t);
      alert("Could not start checkout.");
      return;
    }
    const { url } = await r.json();
    location.href = url;
  }catch(err){
    console.error(err);
    alert("There was a problem starting checkout.");
  }
}

/* ========= INIT ========= */
document.getElementById("btnNext").addEventListener("click", nextStep);
document.getElementById("btnBack").addEventListener("click", prevStep);
document.getElementById("btnBuy").addEventListener("click", startCheckout);

function init(){
  // success watermark removal if you later append success query
  const u = new URLSearchParams(location.search);
  if (u.get("success")==="true"){
    document.body.classList.add("unlocked");
  }
  showStep(0);
}
init();
</script>

</body>
</html>

